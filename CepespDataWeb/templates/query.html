{% extends "layout.html" %}

{% block styles %}

    <link rel="stylesheet" type="text/css"
          href="{{ 'plugins/datatables/extensions/Scroller/css/dataTables.scroller.min.css'|asset }}"/>
    <link rel="stylesheet" type="text/css"
          href="{{ 'plugins/datatables/extensions/ColReorder/css/dataTables.colReorder.min.css'|asset }}"/>
    <link rel="stylesheet" type="text/css"
          href="{{ 'plugins/datatables/plugins/bootstrap/dataTables.bootstrap.css'|asset }}"/>
    <link rel="stylesheet" type="text/css" href="{{ 'plugins/bootstrap-modal/css/bootstrap-modal-bs3patch.css'|asset }}"/>
    <link rel="stylesheet" type="text/css" href="{{ 'plugins/bootstrap-modal/css/bootstrap-modal.css'|asset }}"/>
    <link rel="stylesheet" type="text/css" href="{{ 'plugins/select2/select2.css'|asset }}"/>

{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-md-12">

            <div class="portlet light">
                <div class="portlet-title">
                    <div class="caption font-green-haze">
                        <i class="icon-briefcase"></i>
                        <span class="caption-subject bold uppercase">
                            {{ gettext('pages.query.title') }} <span class="label label-info">BETA</span>
                        </span>
                    </div>
                </div>
                <div class="portlet-body form">

                    <p>{{ gettext('pages.query.description') }}</p>

                    <form action="/consulta/tse" method="get">

                        <div class="form-body">
                            <div class="row">
                                <div class="form-group col-md-3 col-xs-12">
                                    <label for="job-input">{{ gettext('pages.query.job') }}:</label>
                                    <select name="cargo" id="job-input" class="form-control" required>
                                        <option value="1" {% if options.job == 1 %} selected{% endif %}>{{ gettext('query.job.1') }}</option>
                                        <option value="3" {% if options.job == 3 %} selected{% endif %}>{{ gettext('query.job.3') }}</option>
                                        <option value="5" {% if options.job == 5 %} selected{% endif %}>{{ gettext('query.job.5') }}</option>
                                        <option value="6" {% if options.job == 6 %} selected{% endif %}>{{ gettext('query.job.6') }}</option>
                                        <option value="7" {% if options.job == 7 %} selected{% endif %}>{{ gettext('query.job.7') }}</option>
                                        <option value="11" {% if options.job == 11 %} selected{% endif %}>{{ gettext('query.job.11') }}</option>
                                        <option value="13" {% if options.job == 13 %} selected{% endif %}>{{ gettext('query.job.13') }}</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-3 col-xs-12">
                                    <label for="regionalAggregation-input">{{ gettext('pages.query.regional') }}:</label>
                                    <select name="agregacao_regional" id="regionalAggregation-input"
                                            class="form-control" required>
                                        <option value="0" {% if options.reg == 0 %} selected{% endif %}>{{ gettext('query.regional.0') }}</option>
                                        <option value="2" {% if options.reg == 2 %} selected{% endif %}>{{ gettext('query.regional.2') }}</option>
                                        <option value="6" {% if options.reg == 6 %} selected{% endif %}>{{ gettext('query.regional.6') }}</option>
                                        <option value="7" {% if options.reg == 7 %} selected{% endif %}>{{ gettext('query.regional.7') }}</option>
                                        <option value="8" {% if options.reg == 8 %} selected{% endif %}>{{ gettext('query.regional.8') }}</option>
                                        <option value="1" {% if options.reg == 1 %} selected{% endif %}>{{ gettext('query.regional.1') }}</option>
                                        <option value="4" {% if options.reg == 4 %} selected{% endif %}>{{ gettext('query.regional.4') }}</option>
                                        <option value="5" {% if options.reg == 5 %} selected{% endif %}>{{ gettext('query.regional.5') }}</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-3 col-xs-12">
                                    <label for="politicalAggregation-input">{{ gettext('pages.query.political') }}:</label>
                                    <select name="agregacao_politica" id="politicalAggregation-input"
                                            class="form-control" required>
                                        <option value="2" {% if options.pol == 2 %} selected{% endif %}>{{ gettext('query.political.2') }}</option>
                                        <option value="1" {% if options.pol == 1 %} selected{% endif %}>{{ gettext('query.political.1') }}</option>
                                        <option value="3" {% if options.pol == 3 %} selected{% endif %}>{{ gettext('query.political.3') }}</option>
                                        <option value="4" {% if options.pol == 4 %} selected{% endif %}>{{ gettext('query.political.4') }}</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-3 col-xs-12">
                                    <label for="year-input">{{ gettext('pages.query.year') }}:</label>
                                    <select name="anos[]" id="year-input" class="form-control" multiple required>
                                        {% for x in years %}
                                            <option value="{{ x }}"{% if x in options.years %} selected{% endif %}>{{ x }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group col-md-3 col-xs-12" id="filter-uf" {% if reg != 6 and reg != 8 %}style="display: none"{% endif %}>
                                <label for="filter-uf-input">Filter by: <b>UF</b></label>
                                <select name="uf_filter" id="filter-uf-input" class="form-control">
                                    <option value="">UF</option>
                                    {% for uf in uf_list %}
                                        <option value="{{ uf }}" {% if uf == options.uf_filter %}selected{% endif %}>{{ uf }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group col-md-3 col-xs-12" id="filter-mun" {% if reg != 7 %}style="display: none"{% endif %}>
                                <label for="filter-mun-input">Filter by: <b>NOME_MUNICIPIO</b></label>
                                <select name="mun_filter" id="filter-mun-input" class="form-control">
                                    <option value="">Munic√≠pio</option>
                                    {% for (cod, mun, uf) in mun_list %}
                                        <option value="{{ cod }}" {% if cod == options.mun_filter %}selected{% endif %}>{{ mun }} - {{ uf }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                        </div>


                        <div id="brancos-nulos-region">


                            <div class="row">
                                 <div class="col-md-2">
                                    <div class="md-checkbox">
                                        <input type="checkbox" name="brancos" id="brancos-input" class="md-check" value="1" {% if brancos %}checked{% endif %}>
                                        <label for="brancos-input">
                                            <span></span>
                                            <span class="check"></span>
                                            <span class="box"></span>
                                            {{ gettext('pages.query.add') }} <b>VOTOS BRANCOS</b>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-2">
                                    <div class="md-checkbox">
                                        <input type="checkbox" name="nulos" id="nulos-input" class="md-check" value="1" {% if nulos %}checked{% endif %}>
                                        <label for="nulos-input">
                                            <span></span>
                                            <span class="check"></span>
                                            <span class="box"></span>
                                            {{ gettext('pages.query.add') }} <b>VOTOS NULOS</b>
                                        </label>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="form-actions">
                            <button class="btn blue">{{ gettext('pages.home.query') }}</button>
                        </div>
                    </form>

                </div>
            </div>

            <div class="portlet box blue" id="table-area" style="display: none">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="fa fa-globe"></i>Results
                    </div>
                    <div class="actions">
                        <a href="https://github.com/Cepesp-Fgv/tse-dados/issues" target="_blank" class="btn btn-default">
                            <i class="fa fa-github"></i>
                            {{ gettext('pages.query.report-error') }}
                        </a>
                        <button onclick="downloadSql()" class="btn btn-default">
                            <i class="fa fa-database"></i>
                            {{ gettext('pages.query.download-sql') }}
                        </button>
                        <button class="btn btn-primary table-tools" data-target="#columns-modal" data-toggle="modal" disabled>
                            <i class="fa fa-list"></i>
                            {{ gettext('pages.query.add-columns') }}
                        </button>
                        <button class="btn btn-primary table-tools" id="clear-btn" disabled>
                            <i class="fa fa-pencil"></i>
                            {{ gettext('pages.query.clear-filters') }}
                        </button>
                        <button class="btn btn-success table-tools" id="donwload-btn" disabled>
                            <i class="glyphicon glyphicon-download-alt"></i>
                            CSV
                        </button>
                        <a href="javascript:" class="btn btn-default btn-icon-only fullscreen" data-original-title="" title=""></a>
                    </div>
                </div>
                <div class="portlet-body">
                    <table class="table table-striped table-bordered table-hover" id="query-table"></table>
                </div>
            </div>

        </div>
    </div>


    <!-- columns modal -->
    <div id="columns-modal" class="modal container fade" tabindex="-1">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
            <h4 class="modal-title">
                {{ gettext('pages.query.add-columns') }}
            </h4>
        </div>
        <form action="/consulta/tse">
            <input type="hidden" name="cargo" value="{{ options.job }}"/>
            <input type="hidden" name="agregacao_regional" value="{{ options.reg }}"/>
            <input type="hidden" name="agregacao_politica" value="{{ options.pol }}"/>
            <input type="hidden" name="anos" value="{{ options.years|join(',') }}"/>
            <input type="hidden" name="mun_filter" value="{{ options.mun_filter if mun_filter else '' }}"/>
            <input type="hidden" name="uf_filter" value="{{ options.uf_filter if uf_filter else '' }}"/>
            {% if options.brancos %}
            <input type="hidden" name="brancos" value="1"/>
            {% endif %}
            {% if options.nulos %}
            <input type="hidden" name="nulos" value="1"/>
            {% endif %}
            <div class="modal-body">
                <div class="row">
                    {% for column in options.all_columns %}
                        {% if column != 'NOME_COLIGACAO' %}
                        <div class="col-md-4">
                            <div class="md-checkbox">
                                <input type="checkbox" name="selected_columns[]" id="columns-{{ loop.index0 }}" class="md-check" value="{{ column }}" {% if column in selected_columns %}checked{% endif %}>
                                <label for="columns-{{ loop.index0 }}">
                                    <span></span>
                                    <span class="check"></span>
                                    <span class="box"></span>
                                    <b>{{ gettext('columns.' + column) }}</b><br/>
                                    <small class="text-success">{{ gettext('descriptions.' + column) }}</small>
                                </label>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-default">{{ gettext('pages.query.cancel') }}</button>
                <button type="button" class="btn green-haze" id="select-default">{{ gettext('pages.query.select-default') }}</button>
                <button type="button" class="btn green" id="select-all">{{ gettext('pages.query.select-all') }}</button>
                <button type="submit" class="btn blue">{{ gettext('pages.query.update-table') }}</button>
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{{ 'plugins/datatable/js/jquery.dataTables.js'|asset }}"></script>
    <script src="{{ 'plugins/datatables/extensions/Scroller/js/dataTables.scroller.min.js'|asset }}"
            type="text/javascript"></script>
    <script src="{{ 'plugins/datatables/plugins/bootstrap/dataTables.bootstrap.js'|asset }}"
            type="text/javascript"></script>
    <script src="{{ 'plugins/bootstrap/js/bootstrap.min.js'|asset }}"></script>
    <script src="{{ 'plugins/bootstrap-toastr/toastr.min.js'|asset }}"></script>
    <script src="{{ 'plugins/fileDownload/jquery.fileDownload.js'|asset }}"></script>
    <script src="{{ 'plugins/bootstrap-modal/js/bootstrap-modalmanager.js'|asset }}"></script>
    <script src="{{ 'plugins/bootstrap-modal/js/bootstrap-modal.js'|asset }}"></script>
    <script src="{{ 'plugins/select2/select2.min.js'|asset }}"></script>
    <script src="{{ 'js/query.js'|asset }}"></script>
    <script type="text/javascript">
        var COLUMNS = {{ options.selected_columns|tojson }};
        var DEFAULT_COLUMNS = {{ options.default_columns|tojson }};
        var TRANSLATED_COLUMNS = {{ options.translated_columns|tojson }};
        var ENDPOINT = '/api/consulta/tse';

        {% if show %}
            populateTable();
        {% endif %}
    </script>
{% endblock %}